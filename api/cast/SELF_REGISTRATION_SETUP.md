# キャストセルフ登録システム - セットアップ手順

## 📋 概要

キャストが自分でメールアドレスとパスワードを設定できるようになります。
管理者はワンタイムリンクを生成してキャストに送るだけ！

---

## 🔧 セットアップ手順

### STEP 1: データベース更新

以下のSQLを実行してください（phpMyAdminまたはコマンドライン）:

```sql
-- cast_mstテーブルにセルフ登録用カラムを追加
ALTER TABLE cast_mst 
ADD COLUMN registration_token VARCHAR(64) NULL COMMENT 'セルフ登録用ワンタイムトークン',
ADD COLUMN token_expires_at DATETIME NULL COMMENT 'トークン有効期限',
ADD COLUMN token_used_at DATETIME NULL COMMENT 'トークン使用日時';

-- インデックス追加
CREATE INDEX idx_registration_token ON cast_mst(registration_token);
```

または、ファイルを実行:
```
c:\xampp\htdocs\netpgpos\api\setup\add_self_registration_columns.sql
```

---

### STEP 2: 動作確認

#### 2-1. 管理画面を開く
```
http://localhost/netpgpos/api/cast/admin_cast_manager_v2.php
```

#### 2-2. テスト用リンク生成
1. 既存のキャストで「登録リンク生成」ボタンをクリック
2. 生成されたリンクをコピー

#### 2-3. セルフ登録テスト
1. コピーしたリンクを別タブで開く
2. メールアドレスとパスワードを入力
3. 「登録する」をクリック
4. 成功画面が表示されればOK！

#### 2-4. ログインテスト
```
http://localhost/netpgpos/api/cast/cast_login.php
```
設定したメール・パスワードでログインできることを確認

---

## 💡 使い方（本番運用）

### 管理者側の操作

1. **キャスト管理画面を開く**
   ```
   http://localhost/netpgpos/api/cast/admin_cast_manager_v2.php
   ```

2. **登録リンクを生成**
   - 該当キャストの行で「登録リンク生成」をクリック
   - 生成されたURLが表示される

3. **リンクをコピー**
   - 「コピー」ボタンをクリック

4. **キャストに送信**
   - LINE、メール、Slack等でリンクを送る
   ```
   【テンプレート例】
   
   お疲れ様です！
   キャストポータルの登録リンクをお送りします。
   
   以下のリンクを開いて、メールアドレスとパスワードを設定してください。
   （有効期限: 7日間）
   
   [リンクをここに貼り付け]
   
   設定完了後、すぐにログインできるようになります！
   ```

### キャスト側の操作

1. **送られたリンクを開く**
2. **メールアドレスを入力**
3. **パスワードを設定**（8文字以上）
4. **「登録する」をクリック**
5. **完了！** → ログイン画面へ

---

## 🔒 セキュリティ機能

- ✅ **ワンタイムトークン**: 1回使用したら無効化
- ✅ **有効期限**: 7日間で自動失効
- ✅ **パスワードハッシュ化**: データベースに平文保存しない
- ✅ **パスワード強度**: 最低8文字
- ✅ **メール重複チェック**: 同じメールアドレスは登録不可

---

## 📊 ステータス表示

| 表示 | 意味 |
|------|------|
| 🟢 **有効** | ログイン可能 |
| 🟡 **登録待ち** | リンク発行済み、まだ登録していない |
| ⚫ **無効** | まだリンク発行していない |
| ✅ **登録完了** | メール・パスワード設定済み |

---

## ⚠️ トラブルシューティング

### Q: リンクを開いたら「無効な登録リンク」と表示される

**A:** 以下を確認してください:
- トークンが期限切れ（7日経過）
- 既に使用済み
- URLが途中で切れている

→ 管理画面で新しいリンクを生成してください

### Q: 「このメールアドレスは既に使用されています」と表示される

**A:** 同じメールアドレスで既に登録されています。
- 既存アカウントでログインするか
- 別のメールアドレスを使用してください

### Q: リンクを再発行したい

**A:** 管理画面で再度「登録リンク生成」をクリックすれば、新しいリンクが発行されます（古いリンクは自動的に無効化）

---

## 🎯 今後の改善案

- メールでリンクを自動送信
- SMS認証の追加
- 管理者への登録完了通知
- リンク発行履歴の記録

---

## 📝 ファイル一覧

```
api/setup/add_self_registration_columns.sql  - DB更新SQL
api/cast/admin_cast_manager_v2.php          - 管理者用リンク生成画面
api/cast/self_register.php                   - キャスト用セルフ登録画面
```

---

## ✅ セットアップ完了チェックリスト

- [ ] SQLを実行してcast_mstテーブルを更新
- [ ] admin_cast_manager_v2.phpが開ける
- [ ] テスト用リンクを生成できる
- [ ] self_register.phpでメール・パスワードを設定できる
- [ ] 設定後にログインできる
- [ ] 実際のキャストで運用テスト

---

**準備完了！** 管理者の手間を大幅に削減しましょう！🎉
